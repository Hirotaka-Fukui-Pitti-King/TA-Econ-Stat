---
title: "第4回講義コード解説"
subtitle: "2025年度 神戸大学経済学部・経済統計学"
date: today
date-format: "YYYY年M月D日"
author:
  - name: "Hirotaka Fukui"
    email: "227e127e@gsuite.kobe-u.ac.jp"
    affiliations:
      - name: "Kobe University, Graduate School of Economics"

thanks: |
  神戸大学大学院経済学研究科博士後期課程.  
  227e127e@gsuite.kobe-u.ac.jp.  
  無断転載を禁じます.  
  本資料に含まれる誤りはすべて筆者の責任によるものです.  
  内容の正確性を期しておりますが、誤りや印刷上の不備がないことを保証するものではありません。  
  もし誤りを見つけられた場合は、どうぞご連絡ください。

format:
  html:
    theme: default
    mainfont: "Noto Serif JP"
    sansfont: "IBM Plex Sans JP"
    number-sections: true
execute:
  echo: true          
jupyter: nbstata      
brand:
  typography:
    fonts:
      - family: "Noto Serif JP"
        source: google
      - family: "IBM Plex Sans JP"
        source: google
    base: "Noto Serif JP"
    headings:
      family: "IBM Plex Sans JP"
      weight: regular
---

# Stataによる実践（１）

```{stata}
clear all
set more off

*データのインポート

import delimited "4-1.csv", clear
```

解説：

- `clear all` はメモリ上のデータや設定をすべて初期化し、作業を一から始めるためのコマンドです。
- `set more off` は出力が長くても自動で止まらないように設定します（結果が途中で止まらなくなる）。
- `import delimited "4-1.csv", clear` は CSV 形式のデータ（ここでは「4-1.csv」）を読み込みます。
- `clear` オプションで既存データを上書きして新しいデータを読み込みます。
- このコマンドにより、Excelなどで保存された表形式のデータをStataに取り込めます。
- 実際のdoファイルには `cd "'c(do)'" `　というコードが書いてありますがこれは自動的にdoファイルが置かれているフォルダを作業フォルダにするためのコマンドです。
- WindowsでもMacでもLinuxでも、どのOSでも確実にdoファイルを動作させるために入れてあります。
- doファイルを実行する際はデータファイルとdoファイルを同じ場所に置いておいてください。
```{stata}
*データ確認

list id year y rd
```

解説：

- `list` コマンドは、指定した変数の値を一覧表示します。
- `list id year y rd` は、id（個体識別子）、year（年度）、y（被説明変数）、rd（説明変数）の4つを確認しています。
- これにより、データの構造を目視でチェックします。

```{stata}
*パネルデータのセットアップ

xtset id year
```

解説：

- `xtset` は、Stata に「このデータはパネルデータである」と教えるコマンドです。
- `id` が個体（企業・地域など）を識別し、`year` が時間を識別します。
- この設定により、Stata は「同じidの中で時間が進む構造」を理解し、`xtreg`などのパネル分析コマンドを利用できるようになります。

```{stata}
*固定効果モデル推定

xtreg y rd, fe
```

解説：

- `xtreg` はパネルデータの回帰分析を行うコマンドです。
- `xtreg y rd, fe` は 固定効果モデル（Fixed Effects Model） を推定します。
- 固定効果モデルでは、各個体（`id`）や時間(`year`)に固有の効果（観測されない特性）を「ダミー変数」として吸収し、平均的な変化に焦点を当てます。
- これにより、`rd` が `y` に与える純粋な影響を推定できます。

```{stata}
*ランダム効果モデル推定

xtreg y rd, re
```

解説：

- `xtreg y rd, re` は ランダム効果モデル（Random Effects Model） を推定します。
- 固定効果モデルと異なり、固有効果を確率的（ランダム）に扱います。

```{stata}
*データ保存

save 4-1.dta, replace
```

解説：

- `save 4-1.dta, replace` は、現在のデータを Stata 形式（.dta）で保存します。
- `replace` オプションにより、同名ファイルがあっても上書き保存されます。
- .dta 形式は Stata 固有の形式で、後続の分析で直接利用できます。

# Stataによる実践（2）

解説は(1)を参照。

```{stata}
clear all
set more off

*データのインポート

import delimited "4-3.csv", clear
```

```{stata}
*データ確認

list id year old growth
```

```{stata}
*パネルデータのセットアップ

xtset id year
```

```{stata}
*固定効果モデル推定

xtreg growth old, fe
```

```{stata}
*ランダム効果モデル推定

xtreg growth old, re
```

```{stata}
*データ保存

save 4-3.dta, replace
```

# コラム：固定効果モデルとランダム効果モデルにおける定数項の意味

## 固定効果モデルでは「定数項は消える」
   - 固定効果モデルでは、分析の対象となる各個体（企業・地域・人など）が、それぞれ独自の特徴を持っていると考えます。
   - たとえば、ある企業はもともと生産性が高く、別の企業はもともと低いかもしれません。これらの「もともとの違い」を個体ごとの定数として扱うのが固定効果です。
   - そのため、全員に共通するひとつの「切片（全体の出発点）」は推定できません。
   - なぜなら、個体ごとに異なる定数を持たせている時点で、共通の定数項は意味を失うからです。
   - Stataの推定過程では各個体の平均を引き算するwithin変換で固定効果モデルを推定するため、共通の定数項は自動的に消えてしまいます[^1]。


[^1]: 固定効果モデルをダミー変数で表現すると、各個体に専用のダミー（0または1）を付与することで、それぞれに独自の定数項を持たせる形になります。つまり、共通の切片ではなく、個体ごとの切片を同時に含めることになります。その結果として、すべての個体ダミーを入れると、共通の定数項と完全に重複し、多重共線性が発生します。これを回避するためには、1つのダミー（基準グループ）を除外し、残りの個体ダミーのみを推定します。このとき、除外された基準グループのダミーが「参照点」となり、他のダミー変数の係数は基準個体との差として解釈されます。したがって、ダミー変数を用いた場合には、定数項が「残っているように見える」ものの、それは実際には「基準グループの平均値」を表しているにすぎません。各個体の平均を差し引く（within変換を行う）場合と同様に、共通の切片自体は識別されていません。別の方法として、定数項を除外することでこの問題をより直接的に回避することも可能です。この場合は定数項は推定の対象から外れることになります。

## Stataは固定効果モデル推定の際に「あとから定数項を再構成」している
   - 固定効果モデルを推定したあと、各個体の固有効果の平均値を利用すれば、便宜的に「平均的な定数項」を再構成することができます。
   - この値は、理論的な切片ではなく「全体の平均を基準にした出発点」として理解されます。
   - Stata の出力に現れる `_cons`（定数項）は、この再構成された便宜的な値です。
   - つまり、固定効果モデル推定で出てくる定数項は、厳密には共通の切片ではないという点を押さえておく必要があります。

## ランダム効果モデルでは「共通の定数項」が推定できる
  - 一方でランダム効果モデルは、個体ごとの違いを「ばらつき」として捉えます。
  - 全員が共通の出発点（定数項）を持ち、そこに個体ごとのランダムな偏りが加わる、という考え方です。
  - そのため、ランダム効果モデルでは全体の平均的な切片（共通定数項）がきちんと推定されます。
  - ランダム効果モデル推定の場合の `_cons` は、この「全体平均の出発点」を意味します。

たとえばクラス全員の成績の変化を分析するとき、

- 固定効果モデルは「人によってもともとの学力が違う」としてそれを取り除く。

- ランダム効果モデルは「全員がだいたい同じ平均的なスタートラインにいて、そこから偶然の差が生じる」と考える。

わけです。
