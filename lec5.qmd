---
title: "第5回講義コード解説"
subtitle: "2025年度 神戸大学経済学部・経済統計学"
date: today
date-format: "YYYY年M月D日"
author:
  - name: "Hirotaka Fukui"
    email: "227e127e@gsuite.kobe-u.ac.jp"
    affiliations:
      - name: "Kobe University, Graduate School of Economics"

thanks: |
  神戸大学大学院経済学研究科博士後期課程.  
  227e127e@gsuite.kobe-u.ac.jp.  
  無断転載を禁じます.  
  本資料に含まれる誤りはすべて筆者の責任によるものです.  
  内容の正確性を期しておりますが、誤りや印刷上の不備がないことを保証するものではありません。  
  もし誤りを見つけられた場合は、どうぞご連絡ください。

format:
  html:
    theme: default
    mainfont: "Noto Serif JP"
    sansfont: "IBM Plex Sans JP"
    number-sections: true
execute:
  echo: true          
jupyter: nbstata      
brand:
  typography:
    fonts:
      - family: "Noto Serif JP"
        source: google
      - family: "IBM Plex Sans JP"
        source: google
    base: "Noto Serif JP"
    headings:
      family: "IBM Plex Sans JP"
      weight: regular
---

# パネルデータセットの構築 1 (5-0.do)

```{stata}
clear all
set more off

import delimited "5-1.csv", clear
```

```{stata}
*データ確認

list
```

```{stata}
*5-1.csvからインポートしたyに関するデータを一旦5-1.dtaとして保存する

save 5-1.dta, replace
```

解説：


```{stata}
*5-2.csvを読み込んでrdに関するデータをインポートする

import delimited "5-2.csv", clear
```

```{stata}
*データ確認

list
```

```{stata}
*5-1.dtaに含まれるyに関するデータをidのラベルを使って手元にあるrdのデータと結びつける

merge 1:1 id using 5-1.dta
```

解説：

```{stata}
*データ確認

list
```

```{stata}
*データ保存

save 5-2.dta, replace
```

```{stata}
*作ったデータをlong型に変換する

reshape long y rd, i(id) j(year)

```

```{stata}
*データ確認

list
```

```{stata}
*データ保存

save 5-3.dta, replace
```

```{stata}
*パネルデータとして読み込み

xtset id year
```

## doファイルには含まれていないけど、せっかくなのでパネルデータ分析

```{stata}
*固定効果モデル推定

xtreg y rd, fe
```

```{stata}
*ランダム効果モデル推定

xtreg y rd, re
```

# パネルデータセットの構築 2 (5-1.do)

```{stata}
clear all
set more off

*データのインポート

import delimited "5-3.csv", clear
```

```{stata}
*データ確認

list 
```

```{stata}
*5-3.csvからインポートしたyに関するデータを一旦5-4.dtaとして保存する

save 5-4.dta, replace
```

```{stata}

import delimited "5-4.csv", clear
```

```{stata}
*データ確認

list 
```

```{stata}

merge 1:1 id using 5-4.dta
```

```{stata}
*データ確認

list 
```

```{stata}

save 5-5.dta, replace
```

```{stata}

reshape long y iv, i(id) j(year)
```

```{stata}
list
```

```{stata}
save 5-6.dta, replace
```

```{stata}
xtset id year
```

```{stata}
xtreg iv y, fe
```

```{stata}
xtreg iv y, re
```

# おまけ: Rでの実践

```{r}
#| engine: knitr
#| echo: true
library(tidyverse)
library(haven)   # write_dta
library(plm) # FE/RE推定
```

```{r}
#| engine: knitr
#| echo: true

# ========= y と rd をロング化して結合 =========
y_raw  <- read_csv(file="5-1.csv", show_col_types = FALSE)
rd_raw <- read_csv(file="5-2.csv", show_col_types = FALSE)
```

```{r}
#| engine: knitr
#| echo: true

y_raw 
rd_raw
```

```{r}
#| engine: knitr
#| echo: true

y_long <- y_raw |>
  pivot_longer(
    cols = starts_with("y"),   # y1, y2, y3, ...
    names_to = "year",         # 新しい列名
    names_prefix = "y",        # "y" を取り除く
    values_to = "y"            # 値を入れる列名
  ) |>
  mutate(year = 1999 + as.numeric(year))  # 2000, 2001, ...

y_long
```

```{r}
#| engine: knitr
#| echo: true

rd_long <- rd_raw |>
  pivot_longer(
    cols = starts_with("rd"),   # y1, y2, y3, ...
    names_to = "year",         # 新しい列名
    names_prefix = "rd",        # "y" を取り除く
    values_to = "rd"            # 値を入れる列名
  ) |>
  mutate(year = 1999 + as.numeric(year))  # 2000, 2001, ...

rd_long
```

```{r}
#| engine: knitr
#| echo: true

panel_y_rd <- y_long |>
  full_join(rd_long, by = c("id", "year")) |>
  arrange(id, year)

panel_y_rd
```

```{r}
#| engine: knitr
#| echo: true

write_dta(panel_y_rd, "5-3-r.dta")
```

```{r}
#| engine: knitr
#| echo: true

# ========= パネル推定（FE/RE） =========
# NAは落とす
dat <- panel_y_rd |> drop_na(y, rd)

# plmで FE/RE
pdata1 <- pdata.frame(dat, index = c("id", "year"))

fe_mod1 <- plm(y ~ rd, data = pdata1, model = "within")       # 固定効果
re_mod1 <- plm(y ~ rd, data = pdata1, model = "random")       # 変量効果

print(summary(fe_mod1))
print(summary(re_mod1))
```