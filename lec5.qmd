---
title: "第5回講義コード解説"
subtitle: "2025年度 神戸大学経済学部・経済統計学"
date: today
date-format: "YYYY年M月D日"
author:
  - name: "Hirotaka Fukui"
    email: "227e127e@gsuite.kobe-u.ac.jp"
    affiliations:
      - name: "Kobe University, Graduate School of Economics"

thanks: |
  神戸大学大学院経済学研究科博士後期課程.  
  227e127e@gsuite.kobe-u.ac.jp.  
  無断転載を禁じます.  
  本資料に含まれる誤りはすべて筆者の責任によるものです.  
  内容の正確性を期しておりますが、誤りや印刷上の不備がないことを保証するものではありません。  
  もし誤りを見つけられた場合は、どうぞご連絡ください。

format:
  html:
    theme: default
    mainfont: "Noto Serif JP"
    sansfont: "IBM Plex Sans JP"
    number-sections: true
execute:
  echo: true          
jupyter: nbstata      
brand:
  typography:
    fonts:
      - family: "Noto Serif JP"
        source: google
      - family: "IBM Plex Sans JP"
        source: google
    base: "Noto Serif JP"
    headings:
      family: "IBM Plex Sans JP"
      weight: regular
---

# パネルデータセットの構築 1 (5-0.do)

```{stata}
clear all
set more off

import delimited "5-1.csv", clear
```

```{stata}
*データ確認

list
```

```{stata}
*5-1.csvからインポートしたyに関するデータを一旦5-1.dtaとして保存する

save 5-1.dta, replace
```

解説：

- `save 5-1.dta, replace`: 今メモリにあるデータ（`5-1.csv` から読み込んだもの）を `5-1.dta` として保存します。

- この段階で、「`id` と `y` が入ったデータ」をひとまず別ファイルとして保管しておき、あとで `merge` のときに使います。

```{stata}
*5-2.csvを読み込んでrdに関するデータをインポートする

import delimited "5-2.csv", clear
```

解説: 

- `import delimited "5-2.csv", clear`: 新たに 5-2.csv を読み込みます。
- `clear` が付いているので、さきほど読み込んでいたデータはここで消去され、その代わりに `5-2.csv` のデータがメモリに入ります。
- この 5-2.csv の中には `id` と `rd`に関するデータが入っています。

```{stata}
*データ確認

list
```

```{stata}
*5-1.dtaに含まれるyに関するデータをidのラベルを使って手元にあるrdのデータと結びつける

merge 1:1 id using 5-1.dta
```

解説：

- この時点でメモリにあるのは `5-2.csv` 由来のデータ（`id`, `rd` など）です。
- `merge 1:1 id using 5-1.dta`：
  - `merge`：2つのデータセットを結合するコマンド。
  - `1:1 id`：「現在のデータでも `id` は一意、`using` 側（`5-1.dta`）でも `id` は一意で、`id` ごとに1対1で対応しているはず」という指定。
  - つまり、「各 `id` に対して `y` データと `rd` データを1件ずつ対応させて結合する」イメージです。
- `using 5-1.dta`：
  - 先に保存した `5-1.dta` を読み込み、現在のデータに対して `id` をキーにしてマージせよという指定。
  - 結果として、同じ `id` を持つ観測同士が結合され、各行に `id, y, rd` がそろったデータセットが作られます（`_merge` という結合状況を示す変数も自動で作られます）。

```{stata}
*データ確認

list
```

```{stata}
*データ保存

save 5-2.dta, replace
```

- 後でやり直したくなったときに、ここまでの処理を再びやらなくても `5-2.dta` からすぐに読み込めるようにしておくためのステップです。

```{stata}
*作ったデータをlong型に変換する

reshape long y rd, i(id) j(year)

```

解説: 

- `reshape` コマンドは、データの「形」を変える（wide 型 ⇔ long 型）ときに使います。
- `reshape long y rd, i(id) j(year)`：
  - `long`：「long 形式」に変換する、という指定。
  - `y rd`： 変形の対象となる変数の「ベース名」。
  - `i(id)`：個体（パネル）の識別子になる変数名。ここでは `id`。
  - `j(year)`：時間の識別子として新しく作られる変数名。

結果として、

- 行：id と year の組み合わせ
- 列：y と rd（その年の値）

という、典型的なパネルデータの形に変換されます。

```{stata}
*データ確認

list
```

```{stata}
*データ保存

save 5-3.dta, replace
```

```{stata}
*パネルデータとして読み込み

xtset id year
```

## doファイルには含まれていないけど、せっかくなのでパネルデータ分析

```{stata}
*固定効果モデル推定

xtreg y rd, fe
```

```{stata}
*ランダム効果モデル推定

xtreg y rd, re
```

# パネルデータセットの構築 2 (5-1.do)

```{stata}
clear all
set more off

*データのインポート

import delimited "5-3.csv", clear
```

```{stata}
*データ確認

list 
```

```{stata}
*5-3.csvからインポートしたyに関するデータを一旦5-4.dtaとして保存する

save 5-4.dta, replace
```

```{stata}

import delimited "5-4.csv", clear
```

```{stata}
*データ確認

list 
```

```{stata}

merge 1:1 id using 5-4.dta
```

```{stata}
*データ確認

list 
```

```{stata}

save 5-5.dta, replace
```

```{stata}

reshape long y iv, i(id) j(year)
```

```{stata}
list
```

```{stata}
save 5-6.dta, replace
```

```{stata}
xtset id year
```

```{stata}
xtreg iv y, fe
```

```{stata}
xtreg iv y, re
```

# データ処理における「Wide型」と「Long型」

## データ構造

データ分析では、同じ情報でも「どういう形で並べるか」によって扱いやすさが大きく変わります。

- Wide（ワイド）型

- Long（ロング）型

の2種類の形がよく使われます。

## Wide型（ワイド型）とは？

**定義**: 横に変数が並ぶ形式。1行＝1個体で、各時点の値は別々の列になる。

データをとってくるとWide型になっていることが多い

例：y と rd のパネルデータ（例：企業 × 年）

| id | y2018 | y2019 | y2020 | rd2018 | rd2019 | rd2020 |
| -- | ----- | ----- | ----- | ------ | ------ | ------ |
| 1  | 10    | 12    | 13    | 5      | 4      | 6      |
| 2  | 20    | 19    | 22    | 7      | 8      | 9      |

**特徴**

- メリット

1. 見た目が直感的（Excel 的）
2. 個体ごとの変化が横方向で見やすい

- デメリット

1. 時点数が増えると列が爆発的に増える
2. 回帰分析などの推定コマンドを適用しにくい

## Long型（ロング型）とは？

**定義**: 縦に観測が並ぶ形式。1行＝1個体 × 1時点。

例（上と同じデータを Long に変換）

| id | year | y  | rd |
| -- | ---- | -- | -- |
| 1  | 2018 | 10 | 5  |
| 1  | 2019 | 12 | 4  |
| 1  | 2020 | 13 | 6  |
| 2  | 2018 | 20 | 7  |
| 2  | 2019 | 19 | 8  |
| 2  | 2020 | 22 | 9  |

**特徴**

- メリット

1. 分析コマンドがそのまま使える
2. tidyverse（R）や pandas（Python）など多くの分析ツールで標準形
3. 時点数が増えても列数が増えない（扱いやすい）
4. groupby / summarize がしやすい

- デメリット

1. 表のサイズが長くなる
2. 初見だとやや直感的でない




